# 语音交互整体升级策略

参考 ChatGPT Voice、Claude、Hey Gemini 等优秀语音应用的共性，结合 EmoBit 老人陪护场景，制定分阶段升级方案。

---

## 一、现状与差距

### 1.1 当前架构简况

| 环节 | 实现 | 特点 |
|------|------|------|
| 语音识别 | Web Speech API | 免费、实时中间结果、连续识别 |
| 对话 | AI 单轮回复（本地优先 + Groq） | 无流式，整段返回 |
| TTS | Edge TTS + IndexTTS2 克隆 | 见下方「Edge 与克隆分工」 |
| 状态 | `isListening` / `isTalking` / `isThinking` | 有基本反馈 |
| 打断 | 无 | 播放中无法打断 |

**Edge TTS 与克隆音色的分工**（当前约定）：

- **克隆音色**：用户克隆子女声音的目的，是让 **对话、讲解回忆、相册故事、提醒等所有「数字人出声」** 都使用该音色。因此：
  - **对话回复**、**记忆唤醒旁白**、**相册讲解**、**服药/走失提醒**、**试听** 等，一律使用 **当前选中的声音**（若已选克隆则用克隆，否则用预设）。
- **Edge TTS**：仅用于 **与内容无关的即时反馈**，例如：
  - 极短确认音 **「嗯」**（思考中播放，不阻塞），让用户马上感到“有反应”；
  - 克隆服务不可用时的 **降级**（回退到 Edge 预设音）；
  - 将来可选的「极速模式」等特殊场景。
- **预生成缓存**：常用句可预拉 Edge 或克隆（按场景）。**对话/回忆等内容播放**以克隆为准，不牺牲个性化换即时。

### 1.2 与 ChatGPT 等应用的典型差异

| 维度 | 优秀应用常见做法 | 当前 EmoBit |
|------|------------------|-------------|
| **首字/首音延迟** | 流式文本 + 流式 TTS，边生成边播 | 等整句回复 → 再整段 TTS → 再播 |
| **打断（Barge-in）** | 用户一说话即停播、切聆听 | 不支持 |
| **状态机** | Listening → Thinking → Speaking，清晰视觉/动效 | 有 Listening/Talking，缺 Thinking |
| **即时反馈** | “嗯”“好”等短确认音 + 思考动画 | 无 |
| **多轮节奏** | 说完即听、无感切换 | 依赖按钮，节奏略割裂 |
| **弱网/离线** | 降级、排队、缓存 | 基本未考虑 |

---

## 二、整体优化策略（按优先级）

### 2.1 策略 A：缩短「感知延迟」—— 快速首音 + Thinking 状态

**目标**：用户说完后，尽快听到“有反应”，而不是长时间静默。

**做法**：

1. **Thinking 状态**
   - 识别结束 → 显示“思考中”动画（头像/波浪/文案），并进入 `Thinking` 状态。
   - 在调用 AI 之前或之后，可播放 **极短确认音**（如 0.3s “嗯”），用 Edge TTS 或预录制音频，避免久等。

2. **首句优先（可选）**
   - 若 AI 支持流式：收到第一句或第一段（如 `。！？` 断句）即开始 TTS，不必等全文。
   - 当前若为单次返回：可对回复做 **按句切分**，第一句先 TTS 播放，后续句排队或并行合成再续播，减少“等整段”的体感时间。

3. **预生成常用开场**
   - 如“张爷爷，我在呢。”“下午好，今天感觉怎么样？”等，在应用启动或进入老人端时 **预合成**（Edge TTS）并缓存。
   - 命中本地回复时直接播缓存，实现 **零延迟** 开场。

**落地建议**：

- 在 `ElderlyApp` 中明确增加 `thinking` 状态，与 `isListening`、`isTalking` 并列。
- 确认音与预生成开场由 `VoiceService` + 小型缓存（或 `edge_tts_server` 预拉）统一管理。

---

### 2.2 策略 B：流畅轮次切换 —— 说完即听、减少点击

**目标**：更接近“自然对话”节奏，减少“按一下说、再按一下听”的割裂感。

**做法**：

1. **自动进入聆听**
   - AI 播报结束 → 自动开启语音识别（需可配置，如“连续对话模式”开关）。
   - 避免用户每次都要再按一次“麦克风”才能说话。

2. **可配置的连续对话**
   - 连续对话模式：播完 → 短暂间隔（如 0.5s）→ 自动开始聆听。
   - 单轮模式：保持当前“按一次说一次”的行为，适合更保守的交互。

3. **防误触与超时**
   - 自动聆听后，若 N 秒内无有效语音，自动退出聆听并回到待机，避免一直占麦。

**落地建议**：

- 在 `VoiceService.speak` 的 `onEnded` 中触发“自动开始聆听”逻辑（若开启连续对话）。
- 由 `ElderlyApp` 或统一“语音交互控制器”管理：播完 → 延时 → `startRecognition`。

---

### 2.3 策略 C：支持打断（Barge-in）

**目标**：用户一开口，当前 TTS 立即停止，并切换为聆听，符合人类对话习惯。

**做法**：

1. **聆听与播放互斥**
   - 开始语音识别时，若正在播放 TTS，先 `VoiceService.stop()` 停播，再开启识别。

2. **检测“用户正在说话”**
   - 利用 Web Speech API 的 `interimResults`：当出现 **有效中间结果**（如字数 ≥ 1 或 2）时，视为用户开始说话，立即 stop 当前播放并清空待播队列。

3. **简单规则**
   - 仅在有 **播放中** 时启用 barge-in 检测；若未在播，不处理。

**落地建议**：

- 在 `SpeechRecognitionService` 的 `onResult` 中，若 `isFinal === false` 且 `text.trim().length >= 2`，发出 `userBargeIn` 事件。
- `ElderlyApp` 或统一控制器订阅该事件，调用 `VoiceService.stop()`，并将状态切回聆听。

---

### 2.4 策略 D：TTS 分层与智能选择

**目标**：**保留克隆音色**用于所有数字人语音（对话、回忆、提醒等），同时用 Edge 做确认音与降级，不牺牲个性化。

**当前约定**：

- **对话、讲解回忆、相册故事、提醒、试听**：一律使用 **当前选中的声音**（已选克隆则用克隆，否则预设）。克隆慢则通过 **Thinking +「嗯」**、**服务端 (text, voice_id) 缓存**、**预生成** 等缓解体感。
- **「嗯」等极短确认音**：Edge TTS，仅作即时反馈，与“谁在说话”无关。
- **降级**：克隆不可用或超时 → 回退 Edge TTS，可选提示“正在使用默认声音”。

**可继续强化**：

1. **克隆缓存与预生成**
   - 服务端对 `(text, voice_id)` 缓存，重复句（如常用回复、固定提醒）命中即返。
   - 提醒类文案可 **提前异步合成** 并入库，到点播放时直接命中，体感更快。

2. **降级规则**
   - 克隆服务不可用或超时 → 自动回退 Edge TTS，并可选提示“正在使用默认声音”。

**落地建议**：

- `VoiceService.speak` 不对对话/回忆等做 `forceEdgeTTS`；仅特殊场景（如可选“极速模式”）才强制 Edge。
- 提醒、固定话术优先走克隆缓存；若未来有“预生成队列”，在此扩展。

---

### 2.5 策略 E：流式 AI + 流式 TTS（中长期）

**目标**：真正“边说边出”，进一步压缩首字延迟，接近 ChatGPT Voice 体验。

**做法**：

1. **AI 流式**
   - 接入支持 SSE/流式的 API（如 Groq、OpenAI 等），按 token 或按句推送。

2. **按句 TTS**
   - 接收端按句切分（`。！？\n` 等），每凑够一句即送 TTS（Edge 或克隆），**边收边播**，不凑整段。

3. **前后端协议**
   - 若克隆也参与流式：可设计 “sentence stream” 协议（如 WebSocket 消息包含 `{ type: 'sentence', text }`），前端按句请求 TTS 或拉缓存。

**落地建议**：

- 先实现 **AI 流式 + 按句 Edge TTS**，不改克隆流程即可明显改善体感。
- 克隆仍用于“完整句/完整段”的试听、提醒，后续若有流式克隆再接入同一按句管线。

---

### 2.6 策略 F：体验与无障碍

**目标**：状态清晰、可理解、可控制，适老化与无障碍友好。

**做法**：

1. **状态可视化**
   - **Listening**：明显“正在听”动效（如波形、脉动）+ 简短文案“正在聆听…”。
   - **Thinking**： “思考中” 动画 + 可选短确认音。
   - **Speaking**： 播放动效（波形/头像口型等）+ “正在说话” 等提示。

2. **文案与反馈**
   - 用老年人易懂的短句：“没听清，请再说一遍”“正在想呢”等。
   - 错误时给出明确、可操作的提示，而非技术用语。

3. **控制**
   - 保留“停止播放”“再听一次”等入口，便于用户主动控制。

4. **无障碍**
   - 关键状态具备 `aria-live` 等语义，方便读屏；必要时提供“跳过朗读”“仅文字”等选项。

**落地建议**：

- 在 `SmartAvatar` / 老人端顶部状态条中，把 `Listening | Thinking | Speaking` 三态区分开，并配文案与动效。
- 错误、空结果、网络问题等，统一走简单文案 + 可选朗读，避免静默失败。

---

## 三、推荐实施顺序

| 阶段 | 内容 | 预估收益 | 难度 | 状态 |
|------|------|----------|------|------|
| **P0** | Thinking 状态 + 短确认音（“嗯”） | 明显减轻“没反应”焦虑 | 低 | ✅ 已实现 |
| **P0** | 常用开场白预生成 + 缓存播放 | 开场零延迟 | 低 | ✅ 已实现 |
| **P1** | 播完自动进入聆听（可配置） | 轮次更流畅 | 中 | 待做 |
| **P1** | Barge-in：播放中用户说话即停 | 更自然、更可控 | 中 | 待做 |
| **P2** | AI 流式 + 按句 Edge TTS | 首字延迟大幅下降 | 中高 | 待做 |
| **P2** | 提醒类克隆预生成与缓存 | 提醒播放更快 | 中 | 待做 |
| **P3** | 流式克隆、离线降级等 | 体验进一步逼近头部应用 | 高 | 待做 |

### P0 已落地说明

- **Thinking 状态**：识别结束 → `isThinking=true`，头像嘴巴改为琥珀色脉动，对话栏显示「思考中…」；拿到 AI 回复后 `isThinking=false`，再播回复。
- **短确认音**：进入思考后立即播放「嗯」（**Edge TTS**，不阻塞），用户马上有听觉反馈；播**克隆**回复时会 stop 掉「嗯」再播全文。对话、回忆、提醒等**均用当前选中的克隆音色**，不牺牲个性化。
- **预生成与缓存**：`edgeTTSService.preload(['嗯'])` 预拉确认音；**对话等内容走克隆**，服务端对 `(text, voice_id)` 做缓存，重复句命中即返。

### 克隆音色下加快响应的方案（已落地 + 可选）

在**坚持使用克隆音色**的前提下，进一步缩短体感延迟的做法：

| 措施 | 说明 | 状态 |
|------|------|------|
| **按句优先播放** | 回复按 `。！？\n` 拆句，先合成并播放**第一句**，再依次播后续句；首句较短，**首音更快**。 | ✅ 已实现 |
| **克隆常用句预拉** | 选中克隆或进入老人端时，后台对固定句（天气、导航、吃药、照片、谢谢、抱歉等）发起合成，填充服务端缓存；命中即近即时播放。 | ✅ 已实现 |
| **服务端 (text, voice_id) 缓存** | 相同句子 + 同一克隆音再次合成直接命中缓存，无需重复推理。 | ✅ 已有 |
| **GPU / MPS** | 有 NVIDIA GPU 或 Mac M 系时，IndexTTS2 自动用 CUDA/MPS，推理明显加速。 | 环境相关 |
| **torch.compile** | 启动前 `VOICE_CLONE_USE_TORCH_COMPILE=1`，首次推理稍慢，后续可加速。 | 可选 |

**启用说明**：MPS 无需配置（Mac M 系自动启用）；torch.compile 见 `docs/voice-clone-debugging.md` 中「启用 MPS 和 torch.compile 加速」。

---

## 四、与现有实现的衔接

- **语音识别**：继续用 Web Speech API；barge-in 依赖其 `interimResults`。
- **TTS**：对话、回忆、提醒等**均用选中音色（含克隆）**；Edge 仅用于「嗯」与降级。优化点：**按句优先**、**克隆预拉**、**服务端缓存**。
- **状态**：在现有 `isListening` / `isTalking` 基础上，增加 `isThinking`，并由统一状态机驱动 UI。
- **VoiceService**：`speak`、`speakSegments`、`preloadClonePhrases`、`stop`，便于按句播放与预拉。

以上策略可直接作为后续迭代的 roadmap，按阶段选做即可。
