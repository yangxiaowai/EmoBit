# 测试语音识别到回复的完整流程

## 🎯 快速测试步骤

### 1. 确保服务运行

```bash
# 终端 1: FunASR 服务器（必需）
./scripts/start_funasr.sh

# 终端 2: Edge TTS 服务器（用于语音回复）
python scripts/edge_tts_server.py
```

### 2. 打开浏览器控制台

1. 按 `F12` 打开开发者工具
2. 切换到 **Console** 标签页
3. **清空控制台**（重要！）

### 3. 测试语音识别

1. 点击麦克风按钮
2. 说："你好"
3. 停止录音

### 4. 查看完整日志流程

**应该看到以下日志（按顺序）**：

```
[FunASR] ✅ 服务器已就绪，可以开始录音
[FunASR] 🔄 中间结果: 你好
[FunASR] ✅ 最终结果: 你好
============================================================
🎤 语音识别完成: "你好"
============================================================
[SpeechService] 收到识别结果: {text: "你好", isFinal: true}
[ElderlyApp] ============================================================
[ElderlyApp] 📥 收到识别结果: {text: "你好", isFinal: true, ...}
[ElderlyApp] ============================================================
[ElderlyApp] ✅ 最终识别结果: "你好"
[ElderlyApp] ============================================================
[ElderlyApp] 正在调用 AI 服务处理: 你好
[ElderlyApp] ============================================================
[ElderlyApp] 调用 AI 服务，输入: 你好
[ElderlyApp] ============================================================
[AI] ============================================================
[AI] 收到用户消息: 你好
[AI] ============================================================
[AI] ✅ 使用本地回复（节省API调用）
[AI] 回复内容: 张爷爷，您好！今天感觉怎么样？
[AI] ============================================================
[ElderlyApp] ✅ AI 服务响应: {text: "张爷爷，您好！今天感觉怎么样？", ...}
[ElderlyApp] ✅ AI 服务调用成功，回复: 张爷爷，您好！今天感觉怎么样？
[ElderlyApp] 开始播放 AI 回复: 张爷爷，您好！今天感觉怎么样？
[ElderlyApp] Edge TTS 服务状态: ✅ 可用
[VoiceService] 播放语音: "张爷爷，您好！今天感觉怎么样？" (使用Edge TTS，voiceId: xiaoxiao)
[VoiceService] ✅ 语音播放请求已发送
[ElderlyApp] ✅ 语音播放已启动
```

## 🔍 问题定位

### 如果停在某一步，检查：

1. **停在 `[FunASR] ✅ 最终结果`**：
   - 检查 `[SpeechService]` 是否收到结果
   - 检查 `[ElderlyApp]` 是否收到结果

2. **停在 `[ElderlyApp] ✅ 最终识别结果`**：
   - 检查是否看到 `[ElderlyApp] 正在调用 AI 服务处理`
   - 检查是否有错误信息

3. **停在 `[AI] 收到用户消息`**：
   - 检查是否看到 `[AI] ✅ 使用本地回复` 或 `[AI] Gemini 回复`
   - 检查是否有错误信息

4. **停在 `[ElderlyApp] ✅ AI 服务调用成功`**：
   - 检查 Edge TTS 服务状态
   - 检查是否看到 `[VoiceService]` 日志

## 🐛 常见错误

### 错误 1: `识别结果为空`

**原因**：FunASR 没有识别到内容

**解决**：
- 说话声音大一点
- 在安静环境中测试
- 等待识别完成（可能需要几秒）

### 错误 2: `AI 服务返回空响应`

**原因**：AI 服务调用失败或返回空

**解决**：
- 检查控制台是否有 API 错误
- 如果没有 API Key，应该使用本地回复（也能工作）

### 错误 3: `Edge TTS 服务不可用`

**原因**：Edge TTS 服务器未运行

**解决**：
```bash
python scripts/edge_tts_server.py
```

## 📝 记录日志

测试时，请记录：
1. 看到了哪些日志？
2. 在哪一步停止了？
3. 是否有任何红色错误信息？

把这些信息告诉我，我可以帮你精确定位问题！
